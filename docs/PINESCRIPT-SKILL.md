# Alphy PineScript Generation Skill

Comprehensive reference for generating production-grade PineScript v6 indicators and strategies. All scripts generated by Alphy must follow these standards to ensure they are professional, visually polished, and functionally correct.

---

## 1. Script Declaration

### Indicators
```pinescript
//@version=6
indicator(
    title,                    // REQUIRED - script name
    shorttitle,               // display name on chart
    overlay,                  // true = on price chart, false = separate pane
    format,                   // format.inherit | format.price | format.volume | format.percent
    precision,                // 0-16 decimal places
    max_lines_count,          // 1-500 (default 50)
    max_labels_count,         // 1-500 (default 50)
    max_boxes_count,          // 1-500 (default 50)
    max_polylines_count,      // 1-100 (default 50)
    explicit_plot_zorder,     // true = newer plots render on top
    dynamic_requests          // true (default in v6)
)
```

### Strategies
```pinescript
//@version=6
strategy(
    title,                              // REQUIRED
    overlay,                            // true/false
    pyramiding,                         // max successive same-direction entries (default 1)
    default_qty_type,                   // strategy.fixed | strategy.cash | strategy.percent_of_equity
    default_qty_value,                  // qty per entry
    initial_capital,                    // starting equity
    currency,                           // currency.USD etc.
    slippage,                           // ticks
    commission_type,                    // strategy.commission.percent | .cash_per_contract | .cash_per_order
    commission_value,                   // commission amount
    process_orders_on_close,            // true/false
    close_entries_rule,                 // "FIFO" | "ANY"
    margin_long, margin_short,          // percentage
    use_bar_magnifier,                  // true/false
    calc_bars_count                     // limit calc to N bars
)
```

---

## 2. Type System

### Data Types
`string`, `int`, `float`, `bool`, `color`, `line`, `linefill`, `box`, `label`, `table`, `chart.point`, `polyline`, `matrix`, `array`, `map`

### Type Qualifiers (weakest to strongest)
- `const` - known at compile time, never changes
- `input` - set in Settings/Inputs, constant after script loads
- `simple` - known on first bar, constant across all bars
- `series` - can change bar to bar (most flexible)

### Keywords
- `var` - initialize once, persist across bars
- `varip` - persist across intrabars (realtime)
- `import` / `export` - library support
- `method` - extend types with methods
- `type` - user-defined types
- `enum` - enumerated types (v6)

---

## 3. Input Functions

All inputs share these parameters:
| Parameter | Description |
|-----------|-------------|
| `defval` | Default value (REQUIRED) |
| `title` | Label in Settings/Inputs |
| `tooltip` | Hover help text |
| `inline` | Groups widgets on same horizontal line |
| `group` | Collapsible section name |
| `display` | Where to show: `display.all`, `display.status_line`, `display.data_window`, `display.none` |
| `active` | Enable/disable input conditionally |

### Function Signatures
```pinescript
input(defval, title, tooltip, inline, group, display, active)
input.int(defval, title, minval, maxval, step, tooltip, inline, group, confirm, display, active)
input.int(defval, title, options, tooltip, inline, group, confirm, display, active)
input.float(defval, title, minval, maxval, step, tooltip, inline, group, confirm, display, active)
input.float(defval, title, options, tooltip, inline, group, confirm, display, active)
input.bool(defval, title, tooltip, inline, group, confirm, display, active)
input.color(defval, title, tooltip, inline, group, confirm, display, active)
input.string(defval, title, options, tooltip, inline, group, confirm, display, active)
input.source(defval, title, tooltip, inline, group, display, active)
input.timeframe(defval, title, options, tooltip, inline, group, confirm, display, active)
```

### Input Organization (Lux Algo Pattern)
```pinescript
// Group constants
var string GRP_CALC  = "Calculation Settings"
var string GRP_STYLE = "Style"
var string GRP_DASH  = "Dashboard"

// Tooltip constants
string TT_LENGTH = "Lookback period for the main calculation"
string TT_SMOOTH = "Smoothing factor applied to the output"

// Grouped + inlined inputs
length     = input.int(14, "Length", minval=1, tooltip=TT_LENGTH, group=GRP_CALC)
smoothing  = input.int(3, "Smoothing", minval=1, tooltip=TT_SMOOTH, group=GRP_CALC)
src        = input.source(close, "Source", group=GRP_CALC)
method     = input.string("EMA", "Method", options=["SMA", "EMA", "WMA", "VWMA"], group=GRP_CALC)

// Bull/bear colors on same line using inline
bullColor  = input.color(#26a65b, "Bull", inline="colors", group=GRP_STYLE)
bearColor  = input.color(#ef5350, "Bear", inline="colors", group=GRP_STYLE)
fillMode   = input.string("Gradient", "Fill", options=["Gradient", "Solid", "None"], group=GRP_STYLE)

showDash   = input.bool(true, "Show Dashboard", group=GRP_DASH)
dashPos    = input.string("Top Right", "Position", options=["Top Left", "Top Right", "Bottom Left", "Bottom Right"], group=GRP_DASH)
```

---

## 4. Built-in Variables

### Price & Volume
| Variable | Description |
|----------|-------------|
| `open`, `high`, `low`, `close` | OHLC prices |
| `volume` | Bar volume |
| `hl2` | (high + low) / 2 |
| `hlc3` | (high + low + close) / 3 |
| `ohlc4` | (open + high + low + close) / 4 |
| `time`, `time_close` | Bar open/close UNIX timestamp (ms) |
| `bar_index` | Current bar number (0-based) |
| `last_bar_index` | Last bar index |
| `na` | Not Available (null) |

### barstate.* (Bar State)
| Variable | Description |
|----------|-------------|
| `barstate.isconfirmed` | True when bar closes |
| `barstate.isfirst` | True on first bar |
| `barstate.ishistory` | True on historical bars |
| `barstate.islast` | True on last bar |
| `barstate.isnew` | True on first update of bar |
| `barstate.isrealtime` | True on realtime bars |

### syminfo.* (Symbol Info)
| Variable | Description |
|----------|-------------|
| `syminfo.ticker` | Symbol name |
| `syminfo.tickerid` | Full ticker (exchange:symbol) |
| `syminfo.mintick` | Minimum tick size |
| `syminfo.pointvalue` | Point value |
| `syminfo.currency` | Quote currency |
| `syminfo.timezone` | Exchange timezone |
| `syminfo.type` | Symbol type (stock, forex, crypto) |

### timeframe.* (Timeframe)
| Variable | Description |
|----------|-------------|
| `timeframe.isintraday` | True if intraday |
| `timeframe.isdaily` | True if daily |
| `timeframe.isweekly` | True if weekly |
| `timeframe.multiplier` | Timeframe multiplier |
| `timeframe.period` | Current TF string |

### strategy.* (Strategy State)
| Variable | Description |
|----------|-------------|
| `strategy.equity` | Current equity |
| `strategy.position_size` | Position qty (+long, -short, 0 flat) |
| `strategy.position_avg_price` | Average entry price |
| `strategy.netprofit` | Net profit |
| `strategy.max_drawdown` | Maximum drawdown |
| `strategy.wintrades` | Winning trades count |
| `strategy.closedtrades` | Closed trades count |

### chart.* (Chart Properties)
| Variable | Description |
|----------|-------------|
| `chart.bg_color` | Chart background color (theme-aware!) |
| `chart.fg_color` | Chart foreground color |

---

## 5. Technical Analysis Functions (ta.*)

### Moving Averages
```pinescript
ta.sma(source, length)          // Simple Moving Average
ta.ema(source, length)          // Exponential Moving Average
ta.rma(source, length)          // Wilder's Smoothed MA
ta.wma(source, length)          // Weighted Moving Average
ta.vwma(source, length)         // Volume Weighted MA
ta.hma(source, length)          // Hull Moving Average
ta.alma(source, length, offset, sigma) // Arnaud Legoux MA
ta.linreg(source, length, offset)      // Linear Regression
```

### Momentum & Oscillators
```pinescript
ta.rsi(source, length)                          // RSI (0-100)
ta.macd(source, fastlen, slowlen, siglen)       // Returns [macdLine, signalLine, histogram]
ta.stoch(source, high, low, length)             // Stochastic %K
ta.cci(source, length)                          // CCI
ta.mfi(length)                                  // Money Flow Index
ta.tsi(source, short_length, long_length)       // True Strength Index
ta.mom(source, length)                          // Momentum
ta.roc(source, length)                          // Rate of Change
ta.cmo(source, length)                          // Chande Momentum
ta.wpr(high, low, close, length)                // Williams %R
```

### Bands & Channels
```pinescript
ta.bb(source, length, mult)                     // Returns [basis, upper, lower]
ta.kc(source, length, mult, useTrue)            // Keltner [basis, upper, lower]
ta.supertrend(factor, atrPeriod)                // Returns [supertrend, direction]
ta.dmi(diLength, adxSmoothing)                  // Returns [plus, minus, adx]
ta.sar(start, increment, maximum)               // Parabolic SAR
```

### Volatility
```pinescript
ta.atr(length)                  // Average True Range
ta.tr(handleNA)                 // True Range
ta.stdev(source, length)        // Standard Deviation
ta.bbw(source, length, mult)    // Bollinger Band Width
ta.kcw(source, length, mult)    // Keltner Channel Width
```

### Crossovers & Comparison
```pinescript
ta.crossover(source1, source2)  // src1 crosses above src2
ta.crossunder(source1, source2) // src1 crosses below src2
ta.cross(source1, source2)      // any cross
```

### Utility
```pinescript
ta.highest(source, length)          // Highest in period
ta.lowest(source, length)           // Lowest in period
ta.highestbars(source, length)      // Bars since highest
ta.lowestbars(source, length)       // Bars since lowest
ta.barssince(condition)             // Bars since condition true
ta.valuewhen(condition, source, occurrence) // Value when condition was true
ta.change(source, length)           // Change from N bars ago
ta.cum(source)                      // Cumulative sum
ta.correlation(source1, source2, length) // Correlation coefficient
ta.vwap(source)                     // VWAP
ta.percentrank(source, length)      // Percentile rank
ta.median(source, length)           // Median
ta.pivothigh(source, leftbars, rightbars) // Pivot High
ta.pivotlow(source, leftbars, rightbars)  // Pivot Low
```

---

## 6. Plotting Functions

### CRITICAL RULE
`plot()`, `plotshape()`, `plotchar()`, `plotarrow()`, `plotcandle()`, `hline()`, `fill()`, `bgcolor()`, and `barcolor()` CANNOT be inside if/else, for, while, or switch blocks. They MUST be at script global scope. Use `na` or conditional colors to hide them.

### plot()
```pinescript
plot(series, title, color, linewidth, style, trackprice, histbase, offset, join, editable, show_last, display, format, precision, force_overlay)
```

Style constants: `plot.style_line`, `plot.style_linebr`, `plot.style_stepline`, `plot.style_stepline_diamond`, `plot.style_area`, `plot.style_areabr`, `plot.style_columns`, `plot.style_histogram`, `plot.style_circles`, `plot.style_cross`

### plotshape()
```pinescript
plotshape(series, title, style, location, color, offset, text, textcolor, editable, size, show_last, display)
```

Shape constants: `shape.xcross`, `shape.cross`, `shape.circle`, `shape.square`, `shape.diamond`, `shape.triangleup`, `shape.triangledown`, `shape.arrowup`, `shape.arrowdown`, `shape.labelup`, `shape.labeldown`, `shape.flag`

Location: `location.abovebar`, `location.belowbar`, `location.top`, `location.bottom`, `location.absolute`

Size: `size.auto`, `size.tiny`, `size.small`, `size.normal`, `size.large`, `size.huge`

### plotarrow()
```pinescript
plotarrow(series, title, colorup, colordown, offset, minheight, maxheight)
// series > 0 = up arrow, series < 0 = down arrow, 0/na = hidden
```

### plotcandle()
```pinescript
plotcandle(open, high, low, close, title, color, wickcolor, editable, show_last, bordercolor)
```

### fill()
```pinescript
fill(plot1, plot2, color, title, editable, fillgaps)     // Between two plots
fill(hline1, hline2, color, title, editable, fillgaps)   // Between two hlines
// CANNOT mix plot with hline
```

### bgcolor() / barcolor()
```pinescript
bgcolor(color, offset, editable, show_last, title)       // Background color
barcolor(color, offset, editable, show_last, title)       // Candlestick color
```

### hline()
```pinescript
hline(price, title, color, linestyle, linewidth, editable)
// Styles: hline.style_solid, hline.style_dotted, hline.style_dashed
```

---

## 7. Color System

### Color Functions
```pinescript
color.new(color, transp)                                          // 0=opaque, 100=invisible
color.rgb(red, green, blue, transp)                               // RGB (0-255 each)
color.from_gradient(value, bottom_value, top_value, bottom_color, top_color) // Linear gradient
color.r(c), color.g(c), color.b(c), color.t(c)                   // Extract components
```

### Built-in Colors
`color.aqua`, `color.black`, `color.blue`, `color.fuchsia`, `color.gray`, `color.green`, `color.lime`, `color.maroon`, `color.navy`, `color.olive`, `color.orange`, `color.purple`, `color.red`, `color.silver`, `color.teal`, `color.white`, `color.yellow`

Hex: `#RRGGBB` or `#RRGGBBAA`

### Alphy Color Palette (Lux Algo-inspired)
```pinescript
// Primary signal colors
var color BULL_PRIMARY   = #26a65b    // Green (matches aFindr buy)
var color BEAR_PRIMARY   = #ef5350    // Red (matches aFindr sell)
var color BULL_BRIGHT    = #22c55e    // Bright green (strong signals)
var color BEAR_BRIGHT    = #ef4444    // Bright red (strong signals)
var color NEUTRAL        = #9598a1    // Gray (neutral/inactive)

// Accent colors (aFindr brand)
var color ACCENT         = #c47b3a    // Amber (aFindr accent)
var color ACCENT_BRIGHT  = #d4945a    // Light amber

// Transparency levels (Lux Algo convention)
// Strong signal:  transp 0-20
// Normal signal:  transp 30-50
// Background:     transp 70-85
// Subtle/ghost:   transp 90-98
```

### Gradient Fill Pattern (Lux Algo Signature)
```pinescript
// Gradient that fades to chart background (theme-safe)
upper_top_col = bullColor
upper_btm_col = fillMode == "Gradient" ? color.new(chart.bg_color, 100) : bullColor
lower_top_col = fillMode == "Gradient" ? color.new(chart.bg_color, 100) : bearColor
lower_btm_col = bearColor

p_upper = plot(upperLine, color=na, editable=false)
p_basis = plot(basis, color=na, editable=false)
p_lower = plot(lowerLine, color=na, editable=false)

fill(p_upper, p_basis, top_color=upper_top_col, bottom_color=upper_btm_col)
fill(p_basis, p_lower, top_color=lower_top_col, bottom_color=lower_btm_col)
```

---

## 8. Drawing Objects

### line.new()
```pinescript
line.new(x1, y1, x2, y2, xloc, extend, color, style, width, force_overlay)
```
Styles: `line.style_solid`, `line.style_dotted`, `line.style_dashed`, `line.style_arrow_left`, `line.style_arrow_right`, `line.style_arrow_both`

Extend: `extend.none`, `extend.left`, `extend.right`, `extend.both`

### box.new()
```pinescript
box.new(left, top, right, bottom, border_color, border_width, border_style, extend, xloc, bgcolor, text, text_size, text_color, text_halign, text_valign, text_wrap)
```

### label.new()
```pinescript
label.new(x, y, text, xloc, yloc, color, style, textcolor, size, textalign, tooltip, text_font_family, text_formatting)
```

Label styles: `label.style_none`, `label.style_label_up`, `label.style_label_down`, `label.style_label_left`, `label.style_label_right`, `label.style_label_center`, `label.style_circle`, `label.style_square`, `label.style_diamond`, `label.style_triangleup`, `label.style_triangledown`, `label.style_arrowup`, `label.style_arrowdown`, `label.style_flag`, `label.style_xcross`, `label.style_cross`

### polyline.new()
```pinescript
polyline.new(points, curved, closed, xloc, line_color, fill_color, line_style, line_width)
// points: array<chart.point>
```

### linefill.new()
```pinescript
linefill.new(line1, line2, color)
```

### Historical vs. Present Mode (reduce clutter)
```pinescript
if mode == "Present"
    line.delete(myLine[1])
    label.delete(myLabel[1])
```

---

## 9. Table & Dashboard Functions

### table.new()
```pinescript
table.new(position, columns, rows, bgcolor, frame_color, frame_width, border_color, border_width)
```

Positions: `position.top_left`, `position.top_center`, `position.top_right`, `position.middle_left`, `position.middle_center`, `position.middle_right`, `position.bottom_left`, `position.bottom_center`, `position.bottom_right`

### table.cell()
```pinescript
table.cell(table_id, column, row, text, width, height, text_color, text_halign, text_valign, text_size, bgcolor, tooltip, text_font_family, text_formatting)
```

Text alignment: `text.align_left`, `text.align_center`, `text.align_right`
Text formatting: `text.format_bold`, `text.format_italic`, `text.format_none` (combinable with `+`)
Font: `font.family_default`, `font.family_monospace`
Sizes: `size.auto`, `size.tiny`, `size.small`, `size.normal`, `size.large`, `size.huge`

### Dashboard Pattern (Lux Algo Style)
```pinescript
if barstate.islast and showDash
    var dashTable = table.new(position.top_right, 2, 6,
        bgcolor = color.new(chart.bg_color, 0),
        frame_color = color.new(#9598a1, 80),
        frame_width = 1,
        border_color = color.new(#9598a1, 90),
        border_width = 1)

    // Header
    table.cell(dashTable, 0, 0, "METRIC", text_color=#9598a1, text_size=size.tiny,
        text_font_family=font.family_monospace, bgcolor=color.new(chart.bg_color, 20))
    table.cell(dashTable, 1, 0, "VALUE", text_color=#9598a1, text_size=size.tiny,
        text_font_family=font.family_monospace, bgcolor=color.new(chart.bg_color, 20))

    // Trend row with semantic color
    trendStr = trendUp ? "BULLISH" : "BEARISH"
    trendClr = trendUp ? bullColor : bearColor
    table.cell(dashTable, 0, 1, "Trend", text_color=#9598a1, text_size=size.tiny,
        text_font_family=font.family_monospace)
    table.cell(dashTable, 1, 1, trendStr, text_color=trendClr, text_size=size.tiny,
        text_font_family=font.family_monospace, text_formatting=text.format_bold)

    // Signal strength with gradient
    strengthClr = color.from_gradient(strength, 0, 100, bearColor, bullColor)
    table.cell(dashTable, 0, 2, "Strength", text_color=#9598a1, text_size=size.tiny,
        text_font_family=font.family_monospace)
    table.cell(dashTable, 1, 2, str.tostring(strength, "#.#") + "%",
        text_color=strengthClr, text_size=size.tiny, text_font_family=font.family_monospace)
```

---

## 10. Strategy Order Functions

### strategy.entry()
```pinescript
strategy.entry(id, direction, qty, limit, stop, oca_name, oca_type, comment, alert_message)
// direction: strategy.long | strategy.short
// NOTE: 'when' parameter removed in v6 - use if blocks instead
```

### strategy.exit()
```pinescript
strategy.exit(id, from_entry, qty, qty_percent,
    profit,        // ticks (relative)
    limit,         // price (absolute)
    loss,          // ticks (relative)
    stop,          // price (absolute)
    trail_price,   // activation price
    trail_points,  // activation in ticks
    trail_offset,  // trailing distance from best price
    comment, comment_profit, comment_loss, comment_trailing,
    alert_message)
```

### strategy.close() / strategy.close_all()
```pinescript
strategy.close(id, comment, qty, qty_percent, alert_message)
strategy.close_all(comment, alert_message)
```

### strategy.order()
```pinescript
strategy.order(id, direction, qty, limit, stop, oca_name, oca_type, comment, alert_message)
// Unlike entry(): ignores pyramiding, does NOT auto-reverse
```

### strategy.cancel() / strategy.cancel_all()
```pinescript
strategy.cancel(id)
strategy.cancel_all()
```

---

## 11. Multi-Timeframe (request.*)

```pinescript
request.security(symbol, timeframe, expression, gaps, lookahead, ignore_invalid_symbol, currency)
// gaps: barmerge.gaps_off (default) | barmerge.gaps_on
// lookahead: barmerge.lookahead_off (default) | barmerge.lookahead_on

request.security_lower_tf(symbol, timeframe, expression)  // returns array

// In v6, dynamic_requests defaults to true - request.*() can use series args
```

---

## 12. Lux Algo Visual Design Patterns

### Transparency Hierarchy
| Level | Transparency | Use |
|-------|-------------|-----|
| **Primary signals** | 0-20 | Entry/exit markers, active lines |
| **Active elements** | 28-40 | Current bands, zone borders |
| **Background fills** | 70-85 | Order blocks, supply/demand zones |
| **Subtle/ghost** | 90-98 | Historical/mitigated zones |
| **Invisible anchors** | `na` | Plot anchors for fill() only |

### Signal Marker Style Guide
```pinescript
// Strong buy signal (primary)
plotshape(strongBuy, "Strong Buy", shape.triangleup, location.belowbar,
    color=BULL_BRIGHT, size=size.small)

// Normal buy signal (secondary)
plotshape(normalBuy, "Buy", shape.circle, location.belowbar,
    color=color.new(BULL_PRIMARY, 30), size=size.tiny)

// Exit signal
plotshape(exitSignal, "Exit", shape.xcross, location.abovebar,
    color=NEUTRAL, size=size.tiny)

// Weak/early signal (with text)
plotshape(weakBuy, "Early", shape.labelup, location.belowbar,
    color=color.new(BULL_PRIMARY, 60), text="?", textcolor=color.white, size=size.tiny)
```

### Zone/Box Rendering (Order Blocks)
```pinescript
// Active zone (visible)
activeColor = isBullish ? color.new(BULL_PRIMARY, 80) : color.new(BEAR_PRIMARY, 80)
borderColor = isBullish ? color.new(BULL_PRIMARY, 40) : color.new(BEAR_PRIMARY, 40)

// Mitigated zone (faded)
mitigatedColor = color.new(NEUTRAL, 92)
mitigatedBorder = color.new(NEUTRAL, 80)

myBox = box.new(x1, top, x2, bottom,
    border_color = isMitigated ? mitigatedBorder : borderColor,
    border_width = 1,
    bgcolor = isMitigated ? mitigatedColor : activeColor,
    text = "OB", text_size = size.tiny,
    text_color = color.new(NEUTRAL, 50))
```

### Line Style Differentiation
```pinescript
// Internal structure = dashed, small
line.new(x1, y1, x2, y2, color=structColor, style=line.style_dashed, width=1)
label.new(x2, y2, "iBOS", style=label.style_none, textcolor=structColor, size=size.tiny)

// Swing structure = solid, larger
line.new(x1, y1, x2, y2, color=structColor, style=line.style_solid, width=2)
label.new(x2, y2, "BOS", style=label.style_none, textcolor=structColor, size=size.small)
```

### EQ Cloud / Trend Band Pattern
```pinescript
// Bands with gradient fill that fades to chart background
p1 = plot(upper, color=color.new(bullColor, 40), linewidth=1)
p2 = plot(basis, color=na, editable=false, display=display.none)
p3 = plot(lower, color=color.new(bearColor, 40), linewidth=1)

fill(p1, p2,
    top_color = trendUp ? color.new(bullColor, 20) : color.new(chart.bg_color, 100),
    bottom_color = trendUp ? color.new(bullColor, 80) : color.new(chart.bg_color, 100))
fill(p2, p3,
    top_color = not trendUp ? color.new(chart.bg_color, 100) : color.new(bearColor, 80),
    bottom_color = not trendUp ? color.new(bearColor, 20) : color.new(chart.bg_color, 100))
```

### Conditional Bar Coloring
```pinescript
barcolor(
    strongBull ? BULL_BRIGHT :
    weakBull ? color.new(BULL_PRIMARY, 40) :
    strongBear ? BEAR_BRIGHT :
    weakBear ? color.new(BEAR_PRIMARY, 40) :
    na)
```

---

## 13. Code Organization Standard

### File Structure (enforced order)
```pinescript
// 1. License header
// This Pine Script(TM) is subject to the Terms of Use at https://www.tradingview.com/pine-script-terms/
// (C) aFindr

// 2. Version
//@version=6

// 3. Declaration
indicator("aFindr - Smart Trend [Alphy]", shorttitle="SmartTrend", overlay=true,
    max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// 4. Constants
var color BULL = #26a65b
var color BEAR = #ef5350

// 5. Inputs (grouped)
length = input.int(14, "Length", group="Settings")

// 6. User-defined types
type TrendState
    float upper
    float lower
    int direction

// 7. Functions
calcTrend(src, len) =>
    // calculation

// 8. Core calculations
[upper, lower, dir] = calcTrend(close, length)

// 9. Strategy orders (if strategy)
if dir == 1
    strategy.entry("Long", strategy.long)

// 10. Visual elements (plots, fills, drawings)
plot(upper, "Upper", color=BULL)

// 11. Dashboard table
if barstate.islast
    // table rendering

// 12. Alerts
alertcondition(dir == 1, "Bullish", "Bullish trend detected")
```

### Naming Conventions
```pinescript
// Variables & functions: camelCase
maFast = ta.ema(close, 12)
calcPivot(src, left, right) =>

// Constants: SNAKE_CASE
var int MAX_LOOKBACK = 500
var color BULL_COLOR = #26a65b

// Inputs: suffix with Input
lengthInput = input.int(14, "Length")
colorInput = input.color(#26a65b, "Color")

// Plots: suffix with Plot
maPlot = plot(maFast, "Fast MA")

// Tables: suffix with Table or Tbl
dashTbl = table.new(position.top_right, 2, 4)

// Arrays: suffix with Arr
pricesArr = array.new_float()
```

### Documentation Annotations
```pinescript
//@function  Calculates weighted moving average with adaptive period
//@param     source  The source series to average
//@param     length  Base lookback period
//@returns   Smoothed series value
//@type      Describes user-defined type
//@field     Describes type fields
//@variable  Describes variables
```

---

## 14. Complete Example: Alphy Smart Trend Indicator

```pinescript
// (C) aFindr - Generated by Alphy
//@version=6
indicator("aFindr - Smart Trend [Alphy]", shorttitle="Smart Trend", overlay=true,
    max_lines_count=200, max_labels_count=200, max_boxes_count=200,
    explicit_plot_zorder=true)

// ─── Constants ───
var color BULL      = #26a65b
var color BEAR      = #ef5350
var color NEUTRAL   = #9598a1
var color ACCENT    = #c47b3a

// ─── Inputs ───
var string GRP_CALC  = "Calculation"
var string GRP_STYLE = "Style"
var string GRP_DASH  = "Dashboard"
var string GRP_ALERT = "Alerts"

string TT_FACTOR = "Higher = wider bands, fewer signals. Lower = tighter bands, more signals."
string TT_SMOOTH = "Smoothing applied to the trend bands."

atrLen     = input.int(10, "ATR Length", minval=1, group=GRP_CALC)
factor     = input.float(3.0, "Factor", minval=0.1, step=0.1, tooltip=TT_FACTOR, group=GRP_CALC)
smoothLen  = input.int(1, "Smoothing", minval=1, tooltip=TT_SMOOTH, group=GRP_CALC)

bullCss    = input.color(BULL, "Bull", inline="clr", group=GRP_STYLE)
bearCss    = input.color(BEAR, "Bear", inline="clr", group=GRP_STYLE)
fillMode   = input.string("Gradient", "Fill Mode", options=["Gradient", "Solid", "None"], group=GRP_STYLE)
showSignals = input.bool(true, "Show Signals", group=GRP_STYLE)
showDash   = input.bool(true, "Show Dashboard", group=GRP_DASH)
alertBull  = input.bool(true, "Alert on Bullish", group=GRP_ALERT)
alertBear  = input.bool(true, "Alert on Bearish", group=GRP_ALERT)

// ─── Calculations ───
[st, dir] = ta.supertrend(factor, atrLen)
smoothSt = smoothLen > 1 ? ta.ema(st, smoothLen) : st

isBull = dir < 0
isBear = dir > 0
bullFlip = isBull and not isBull[1]
bearFlip = isBear and not isBear[1]

// ─── Trend Line ───
trendColor = isBull ? bullCss : bearCss
plot(smoothSt, "SuperTrend", color=trendColor, linewidth=2)

// ─── Gradient Fill ───
p_close = plot(close, display=display.none, editable=false)
p_trend = plot(smoothSt, display=display.none, editable=false)

fillTopCol = fillMode == "None" ? na : isBull ? color.new(bullCss, fillMode == "Gradient" ? 85 : 80) : na
fillBtmCol = fillMode == "None" ? na : isBear ? color.new(bearCss, fillMode == "Gradient" ? 85 : 80) : na

fill(p_close, p_trend,
    top_color = close > smoothSt ? fillTopCol : fillBtmCol,
    bottom_color = close > smoothSt ? fillTopCol : fillBtmCol)

// ─── Signal Markers ───
plotshape(showSignals and bullFlip ? smoothSt : na, "Bull Signal",
    shape.triangleup, location.absolute, bullCss, size=size.small)
plotshape(showSignals and bearFlip ? smoothSt : na, "Bear Signal",
    shape.triangledown, location.absolute, bearCss, size=size.small)

// ─── Bar Coloring ───
barcolor(isBull ? color.new(bullCss, 60) : color.new(bearCss, 60))

// ─── Dashboard ───
if barstate.islast and showDash
    var tbl = table.new(position.top_right, 2, 4,
        bgcolor=color.new(chart.bg_color, 10),
        frame_color=color.new(NEUTRAL, 80), frame_width=1,
        border_color=color.new(NEUTRAL, 90), border_width=1)

    table.cell(tbl, 0, 0, "SMART TREND", text_color=ACCENT, text_size=size.tiny,
        text_font_family=font.family_monospace, text_formatting=text.format_bold)
    table.cell(tbl, 1, 0, syminfo.ticker, text_color=NEUTRAL, text_size=size.tiny,
        text_font_family=font.family_monospace)

    table.cell(tbl, 0, 1, "Trend", text_color=NEUTRAL, text_size=size.tiny,
        text_font_family=font.family_monospace)
    table.cell(tbl, 1, 1, isBull ? "BULLISH" : "BEARISH",
        text_color=isBull ? bullCss : bearCss, text_size=size.tiny,
        text_font_family=font.family_monospace, text_formatting=text.format_bold)

    barsInTrend = ta.barssince(bullFlip or bearFlip)
    table.cell(tbl, 0, 2, "Duration", text_color=NEUTRAL, text_size=size.tiny,
        text_font_family=font.family_monospace)
    table.cell(tbl, 1, 2, str.tostring(barsInTrend) + " bars",
        text_color=color.new(chart.fg_color, 20), text_size=size.tiny,
        text_font_family=font.family_monospace)

    distPct = math.abs(close - smoothSt) / close * 100
    table.cell(tbl, 0, 3, "Distance", text_color=NEUTRAL, text_size=size.tiny,
        text_font_family=font.family_monospace)
    table.cell(tbl, 1, 3, str.tostring(distPct, "#.##") + "%",
        text_color=color.from_gradient(distPct, 0, 5, NEUTRAL, ACCENT),
        text_size=size.tiny, text_font_family=font.family_monospace)

// ─── Alerts ───
alertcondition(alertBull and bullFlip, "Bullish Trend", "Smart Trend flipped BULLISH on " + syminfo.ticker)
alertcondition(alertBear and bearFlip, "Bearish Trend", "Smart Trend flipped BEARISH on " + syminfo.ticker)
```

---

## 15. Quality Checklist

Every script generated by Alphy MUST pass these checks:

### Structure
- [ ] Uses `//@version=6`
- [ ] Has proper `indicator()` or `strategy()` declaration with meaningful title
- [ ] Shorttitle includes `[Alphy]` suffix
- [ ] Constants declared with `var` at top
- [ ] Inputs organized with `group` and `inline` parameters
- [ ] Meaningful tooltips on non-obvious inputs
- [ ] Functions defined before use
- [ ] Plots at global scope (never inside conditionals)

### Visual Quality (Lux Algo Standard)
- [ ] Uses semantic color palette (bull=green, bear=red, neutral=gray, accent=amber)
- [ ] Transparency hierarchy: signals < bands < fills < ghost elements
- [ ] Gradient fills use `chart.bg_color` for theme compatibility
- [ ] Signal markers use appropriate shapes and sizes
- [ ] Dashboard table uses `font.family_monospace` and `size.tiny`
- [ ] No visual clutter - offer "Historical vs Present" mode when >50 drawings

### Functional Quality
- [ ] All inputs have sensible defaults and min/max constraints
- [ ] Strategy uses `strategy.exit()` for risk management when applicable
- [ ] Alert conditions defined for all signals
- [ ] Multi-timeframe requests use `barmerge.lookahead_off` (no future leak)
- [ ] `barstate.isconfirmed` used for realtime-safe calculations

### Naming
- [ ] Variables: `camelCase`
- [ ] Constants: `SNAKE_CASE`
- [ ] Inputs suffixed: `lengthInput` or grouped clearly
- [ ] Plots suffixed: `maPlot`
- [ ] Tables suffixed: `dashTbl`
